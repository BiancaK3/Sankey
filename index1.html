<!DOCTYPE html>
<meta charset="utf-8">
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="pathSankey.js"></script>
<link rel="stylesheet" href="style.css"> 
</head>
<body>
<script>

var nominalWidth = 500;
var nominalHeight = 250;
var layerStructure = [2, 3, 2];
var connectionProbability = 0.4;

var chart = d3.pathSankey()
							.width(nominalWidth).height(nominalHeight)
							.selectedNodeAddress([0,0,0]);


function initialize() {
	d3.select("body")
	.append("svg")
		.attr("viewBox", "0 0 "+nominalWidth+" "+nominalHeight)
		.attr("preserveAspectRatio","xMinYMin meet");

	var enteringInputGroups = d3.select("body").selectAll("input")
																.data(layerStructure)
																.enter()
																.append("div");
	enteringInputGroups
		.append("span").html(function(d,i) {return "Layer " + i + ": ";});
	enteringInputGroups
		.append("input")
			.attr("type", "number")
			.attr("min", 1)
			.attr("max", 20)
			.attr("value", function(d) {return d;})
			.on("change", function(d,i) {
				if (layerStructure[i] != this.value) {
					layerStructure[i] = this.value;
					bind();
				}
			});
	enteringInputGroups
		.append("span").html(" nodes.");

	d3.select("body")
		.append("input")
		.attr("type", "button")
		.attr("value", "Randomize data")
		.on("click", bind);

	bind();
	d3.select(window).on("resize",draw);
}

function bind() {
	var data = {};
	d3.json("sankey-teste.json", function(error, graph) { 
		data = graph;
		//console.log(makeRandomData(layerStructure))
		d3.select("svg").datum(data);
		draw();
	}); 
	
}

function draw() {

	// find inner width of container element (body)
	var cs = window.getComputedStyle(d3.select('body').node());
	var width = parseInt(cs.width) - parseInt(cs.paddingLeft) - parseInt(cs.paddingRight);
	width = width > nominalWidth ? nominalWidth : width;
	var height = Math.round(width * nominalHeight/nominalWidth); 

	// set width/height of svg element, svg has viewBox so elements will just scale down
	d3.select("svg")
		.html("")
		.attr("width", width)
		.attr("height", height)
		.call(chart);
}

function makeRandomData(layers) {
	function randInt(min, max) {
		return Math.round(Math.random() * (max - min)) + min;
	}

	var numLayers = layers.length;
	var ret = {nodes: [], flows: []};
	
	// make up some nodes
	for (var i=0; i < numLayers; i++) {
		var nodes = [];
		var group = {items: nodes, title: "", label:0};
		var layer = {items: [group], title: "Layer "+i, x: i/(numLayers-1)};
		var numNodes = layers[i];
		for (var j=0; j < numNodes; j++) {
			nodes.push({title: "Node "+(i*numLayers+j), color: d3.rgb(randInt(20,200), randInt(20,200), randInt(20,200))});
		}
		ret.nodes.push(layer);
	}
	
	// make up some flows
	function getPathsRecursively(lists, n) {
		if (n === -1) {
			return [[]];
		}
		var restOfPaths = getPathsRecursively(lists, n-1);
		var paths = [];
		restOfPaths.forEach(function(rest) {
			lists[n].forEach(function(d,i) {
				paths.push(rest.concat([[n,0,i]]));
			});
		});
		return paths;
	}
	function getPaths(lists) {
		return getPathsRecursively(lists, lists.length-1);
	}
	
	var allPaths = getPaths(ret.nodes.map(function(d) {return d.items[0].items;})); 
	allPaths.forEach(function(path){
		if (Math.random() < connectionProbability) {
			ret.flows.push({magnitude: randInt(10,250), path: path});
		}
	});

	return ret;  
}

initialize();
</script>
</body>